<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ìì„¸ê¸ˆê³„ì‚°ì„œ-ëœë”©
    </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            font-size: 11px;
        }

        .container {
            margin: 0 auto;
            padding: 0 20px;
            max-width: 700px;
        }

        .upload-area {
            background: white;
            border: 2px dashed #2196F3;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f7ff;
            border-color: #1976D2;
        }

        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #1565c0;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        .search-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .search-section h3 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #333;
        }

        .search-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }

        .search-input-group input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .search-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #1976D2;
        }

        .search-btn:active {
            background: #1565c0;
        }

        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .print-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 20px 0;
        }

        .print-btn:hover {
            background: #1976D2;
        }

        .invoice-paper {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .title {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #999;
        }

        .approval-info {
            text-align: right;
            font-size: 10px;
            margin-bottom: 10px;
        }

        .approval-info strong {
            font-size: 12px;
        }

        /* í†µí•© party í…Œì´ë¸” */
        .unified-party-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 1px solid #999;
            border-left: 1px solid #999;
            margin-bottom: 40px;
            table-layout: fixed;
        }

        .unified-party-table td {
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 4px;
            font-size: 10px;
            word-break: break-word;
        }

        .party-indicator {
            text-align: center;
            font-weight: bold;
            width: 40px;
            padding: 5px 2px;
            font-size: 10px;
            line-height: 1.2;
            vertical-align: middle;
        }

        .party-indicator.pink {
            background: #f0d8e8;
        }

        .party-indicator.blue {
            background: #d4e6f1;
        }

        .party-label {
            background: #f5e6f0;
            font-weight: bold;
            padding: 6px;
            font-size: 10px;
            text-align: center;
            min-width: 50px;
        }

        .party-label.blue {
            background: #d4e6f1;
        }

        .party-value {
            padding: 6px;
            font-size: 11px;
        }

        .party-value.address {
            height: 45px;
            vertical-align: top;
        }

        /* ì‘ì„±ì¼ì ì„¹ì…˜ */
        .date-section {
            margin-bottom: 15px;
        }

        .date-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 1px solid #999;
            border-left: 1px solid #999;
        }

        .date-table td {
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 4px;
            font-size: 10px;
        }

        .date-label {
            font-weight: bold;
            background: #f5f5f5;
            text-align: center;
        }

        .date-value {
            background: white;
        }

        /* í’ˆëª© ì„¹ì…˜ */
        .section-title {
            font-weight: bold;
            font-size: 11px;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 1px solid #999;
            border-left: 1px solid #999;
            margin-bottom: 20px;
        }

        .items-table th {
            background: #e8e8e8;
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 9px;
            height: 25px;
        }

        .items-table td {
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 3px;
            font-size: 10px;
            text-align: right;
            height: 20px;
        }

        .items-table td.left {
            text-align: left;
        }

        .items-table td.center {
            text-align: center;
        }

        .items-table tbody tr:nth-child(n+2) td {
            background: #f9f9f9;
        }

        /* í•©ê³„ê¸ˆì•¡ ì„¹ì…˜ */
        .summary-section {
            margin-top: 30px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 1px solid #999;
            border-left: 1px solid #999;
        }

        .summary-table td {
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            padding: 4px;
            font-size: 10px;
            background: #f9f9f9;
        }

        .summary-label {
            background: #f0f0f0;
            font-weight: bold;
            text-align: center;
        }

        .summary-value {
            text-align: right;
            font-weight: bold;
        }

        .footer-text {
            text-align: right;
            font-size: 10px;
            margin-top: 5px;
        }

        @media print {

            .upload-area,
            .print-btn {
                display: none;
            }

            .invoice-paper {
                box-shadow: none;
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="margin-bottom: 30px; text-align: center;">ì „ìì„¸ê¸ˆê³„ì‚°ì„œ ë Œë”ëŸ¬</h1>

        <div class="search-section">
            <h3>ğŸ“‹ ì„¸ê¸ˆê³„ì‚°ì„œ ë²ˆí˜¸ë¡œ ê²€ìƒ‰</h3>
            <div class="search-input-group">
                <input type="text" id="searchInput" placeholder="ì˜ˆ: 202501141025012023007622" maxlength="24">
                <button class="search-btn" id="searchBtn">ê²€ìƒ‰</button>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div class="upload-text">XML íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸&ë“œë¡­í•˜ì„¸ìš”</div>
            <div class="upload-hint">ë˜ëŠ” í´ë¦­í•´ì„œ íŒŒì¼ ì„ íƒ</div>
            <input type="file" id="fileInput" accept=".xml" />
        </div>

        <div id="messageArea"></div>

        <div id="invoiceArea" style="display: none;">
            <div class="upload-area" id="uploadArea2" style="margin-bottom: 20px; padding: 20px;">
                <div style="font-size: 12px; color: #666;">ğŸ“„ ìƒˆ íŒŒì¼ì„ ë“œë˜ê·¸&ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ë‹¤ë¥¸ ì„¸ê¸ˆê³„ì‚°ì„œ ì—´ê¸°</div>
                <input type="file" id="fileInput2" accept=".xml" style="display: none;" />
            </div>
            <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            <button class="print-btn" style="background: #FF6B6B; margin-left: 10px;" onclick="resetForm()">ğŸ”„
                ì´ˆê¸°í™”</button>
            <div class="invoice-paper" id="invoicePaper"></div>
            <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const invoiceArea = document.getElementById('invoiceArea');
        const invoicePaper = document.getElementById('invoicePaper');
        const messageArea = document.getElementById('messageArea');

        const uploadArea2 = document.getElementById('uploadArea2');
        const fileInput2 = document.getElementById('fileInput2');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea2.addEventListener('click', () => fileInput2.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        uploadArea2.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea2.classList.add('dragover');
        });

        uploadArea2.addEventListener('dragleave', () => {
            uploadArea2.classList.remove('dragover');
        });

        uploadArea2.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea2.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        fileInput2.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchBtn.addEventListener('click', searchByNumber);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchByNumber();
            }
        });

        async function searchByNumber() {
            const invoiceNumber = searchInput.value.trim();

            if (!invoiceNumber) {
                showMessage('ì„¸ê¸ˆê³„ì‚°ì„œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (invoiceNumber.length !== 24) {
                showMessage('ì„¸ê¸ˆê³„ì‚°ì„œ ë²ˆí˜¸ëŠ” 24ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            try {
                showMessage('ê²€ìƒ‰ ì¤‘...', 'success');

                // XML í´ë”ì—ì„œ íŒŒì¼ ì°¾ê¸° ì‹œë„
                const xmlFileName = invoiceNumber + '.xml';

                // ë¡œì»¬ íŒŒì¼ ì‹œìŠ¤í…œì—ì„œ ì°¾ê¸° ì‹œë„
                try {
                    const response = await fetch('./XML/' + xmlFileName);

                    if (response.ok) {
                        const xmlText = await response.text();
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                        if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                            throw new Error('XML íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        }

                        renderInvoice(xmlDoc);
                        uploadArea.style.display = 'none';
                        invoiceArea.style.display = 'block';
                        showMessage('ì„¸ê¸ˆê³„ì‚°ì„œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (' + xmlFileName + ')', 'success');
                    } else {
                        showMessage('í•´ë‹¹ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + xmlFileName, 'error');
                    }
                } catch (fetchError) {
                    // IndexedDB ë°©ì‹ ì‹œë„ (ë˜ëŠ” ë‹¤ë¥¸ ë¡œì»¬ ì €ì¥ì†Œ)
                    showMessage('íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì§ì ‘ ë“œë˜ê·¸í•´ì£¼ì„¸ìš”.', 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function handleFile(file) {
            if (!file.name.endsWith('.xml')) {
                showMessage('XML íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const xmlText = e.target.result;
                    console.log('íŒŒì¼ëª…:', file.name);
                    console.log('íŒŒì¼ í¬ê¸°:', xmlText.length, 'bytes');

                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        console.error('XML íŒŒì‹± ì—ëŸ¬:', xmlDoc.getElementsByTagName('parsererror')[0].textContent);
                        throw new Error('XML íŒŒì¼ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }

                    console.log('XML ë¬¸ì„œ íŒŒì‹± ì„±ê³µ');

                    renderInvoice(xmlDoc);
                    uploadArea.style.display = 'none';
                    invoiceArea.style.display = 'block';
                    showMessage('ì„¸ê¸ˆê³„ì‚°ì„œê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
                    showMessage('ì˜¤ë¥˜: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function showMessage(msg, type) {
            messageArea.innerHTML = `<div class="message ${type}">${msg}</div>`;
            if (type === 'success') {
                setTimeout(() => {
                    messageArea.innerHTML = '';
                }, 3000);
            }
        }

        function resetForm() {
            uploadArea.style.display = 'block';
            invoiceArea.style.display = 'none';
            invoicePaper.innerHTML = '';
            fileInput.value = '';
            messageArea.innerHTML = '';
        }

        function getElementText(parent, tagName) {
            if (!parent) return '';
            const allChildren = parent.childNodes;
            for (let child of allChildren) {
                if (child.nodeType === 1) {
                    const localName = child.localName || child.nodeName.split(':').pop();
                    if (localName === tagName) {
                        return child.textContent.trim();
                    }
                }
            }
            return '';
        }

        function findChild(parent, tagName) {
            if (!parent) return null;
            const allChildren = parent.childNodes;
            for (let child of allChildren) {
                if (child.nodeType === 1) {
                    const localName = child.localName || child.nodeName.split(':').pop();
                    if (localName === tagName) {
                        return child;
                    }
                }
            }
            return null;
        }

        function findAllChildren(parent, tagName) {
            if (!parent) return [];
            const result = [];
            const allChildren = parent.childNodes;
            for (let child of allChildren) {
                if (child.nodeType === 1) {
                    const localName = child.localName || child.nodeName.split(':').pop();
                    if (localName === tagName) {
                        result.push(child);
                    }
                }
            }
            return result;
        }

        function formatNumber(num) {
            return parseInt(num || 0).toLocaleString('ko-KR');
        }

        function formatBRN(brn) {
            // XXX-XX-XXXXX í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
            if (!brn) return '';
            brn = brn.replace(/[^0-9]/g, '');
            if (brn.length === 10) {
                return brn.substring(0, 3) + '-' + brn.substring(3, 5) + '-' + brn.substring(5);
            }
            return brn;
        }

        function formatApprovalNumber(issueId) {
            // YYYYMMDD-YYYYMMDD-XXXXXXXX í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
            if (!issueId) return '';
            issueId = issueId.replace(/[^0-9]/g, '');
            if (issueId.length === 24) {
                // 202512021025120257362283 -> 20251202-10251202-57362283
                return issueId.substring(0, 8) + '-' + issueId.substring(8, 16) + '-' + issueId.substring(16);
            }
            return issueId;
        }

        function getAmendmentReason(code) {
            const reasons = {
                '01': 'ê¸°ì¬ì‚¬í•­ì°©ì˜¤ì •ì •',
                '04': 'ê³„ì•½ì˜í•´ì œ'
            };
            return reasons[code] || '';
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr || dateStr.length < 8) return dateStr;
            return `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
        }

        function renderInvoice(xmlDoc) {
            try {
                const root = xmlDoc.documentElement;
                console.log('=== XML íŒŒì‹± ì‹œì‘ ===');
                console.log('Root element:', root.nodeName);

                // ê¸°ë³¸ ì •ë³´
                const taxInvoiceDoc = findChild(root, 'TaxInvoiceDocument');
                console.log('0. TaxInvoiceDocument ì°¾ê¸°:', taxInvoiceDoc ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

                const issueId = getElementText(taxInvoiceDoc, 'IssueID');
                console.log('1. IssueID íŒŒì‹±:');
                console.log('   - ì›ë³¸ IssueID:', issueId);
                console.log('   - í¬ë§·íŒ…ëœ IssueID:', formatApprovalNumber(issueId));

                const issueDateEl = findChild(taxInvoiceDoc, 'IssueDateTime');
                const issueDate = issueDateEl ? issueDateEl.textContent : '';
                console.log('2. IssueDateTime íŒŒì‹±:', issueDate);

                // ìˆ˜ì • ì—¬ë¶€ í™•ì¸
                const typeCode = getElementText(taxInvoiceDoc, 'TypeCode');
                const descriptionText = getElementText(taxInvoiceDoc, 'DescriptionText');
                const amendmentCode = getElementText(taxInvoiceDoc, 'AmendmentStatusCode');
                console.log('3. ìˆ˜ì • ì •ë³´:');
                console.log('   - TypeCode:', typeCode);
                console.log('   - AmendmentStatusCode:', amendmentCode);
                console.log('   - DescriptionText:', descriptionText);
                console.log('   - ìˆ˜ì •ì‚¬ìœ :', getAmendmentReason(amendmentCode));

                // InvoicerParty ì •ë³´
                const settlement = findChild(root, 'TaxInvoiceTradeSettlement');
                console.log('4. TaxInvoiceTradeSettlement ì°¾ê¸°:', settlement ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

                const invoicerParty = findChild(settlement, 'InvoicerParty');
                console.log('5. InvoicerParty ì°¾ê¸°:', invoicerParty ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

                const invoicerBrn = getElementText(invoicerParty, 'ID');
                const invoicerName = getElementText(invoicerParty, 'NameText');
                const invoicerPersonName = getElementText(findChild(invoicerParty, 'SpecifiedPerson'), 'NameText');
                const invoicerTypeCode = getElementText(invoicerParty, 'TypeCode');
                const invoicerClassCode = getElementText(invoicerParty, 'ClassificationCode');
                const invoicerEmail = getElementText(findChild(invoicerParty, 'DefinedContact'), 'URICommunication');
                const invoicerAddress = getElementText(findChild(invoicerParty, 'SpecifiedAddress'), 'LineOneText');

                console.log('   - ê³µê¸‰ì BRN:', invoicerBrn);
                console.log('   - ê³µê¸‰ì ìƒí˜¸:', invoicerName);

                // InvoiceeParty ì •ë³´
                const invoiceeParty = findChild(settlement, 'InvoiceeParty');
                const invoiceeBrn = getElementText(invoiceeParty, 'ID');
                const invoiceeName = getElementText(invoiceeParty, 'NameText');
                const invoiceePersonName = getElementText(findChild(invoiceeParty, 'SpecifiedPerson'), 'NameText');
                const invoiceeTypeCode = getElementText(invoiceeParty, 'TypeCode');
                const invoiceeClassCode = getElementText(invoiceeParty, 'ClassificationCode');
                const invoiceeEmail = getElementText(findChild(invoiceeParty, 'PrimaryDefinedContact'), 'URICommunication');
                const invoiceeAddress = getElementText(findChild(invoiceeParty, 'SpecifiedAddress'), 'LineOneText');

                // í•­ëª© ì •ë³´
                const items = findAllChildren(root, 'TaxInvoiceTradeLineItem');
                const itemData = [];

                items.forEach(item => {
                    const name = getElementText(item, 'NameText');
                    const quantity = getElementText(item, 'ChargeableUnitQuantity');
                    const unitPriceEl = findChild(item, 'UnitPrice');
                    const unitPrice = getElementText(unitPriceEl, 'UnitAmount');
                    const amount = getElementText(item, 'InvoiceAmount');
                    const totalTaxEl = findChild(item, 'TotalTax');
                    const tax = getElementText(totalTaxEl, 'CalculatedAmount');

                    if (name && quantity && amount) {
                        itemData.push({
                            name: name,
                            quantity: quantity,
                            unitPrice: unitPrice || amount,
                            amount: amount,
                            tax: tax
                        });
                    }
                });

                // ê¸ˆì•¡ ì •ë³´
                const monetarySummation = findChild(settlement, 'SpecifiedMonetarySummation');
                console.log('6. SpecifiedMonetarySummation ì°¾ê¸°:', monetarySummation ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');

                const subtotal = getElementText(monetarySummation, 'ChargeTotalAmount');
                const taxAmount = getElementText(monetarySummation, 'TaxTotalAmount');
                const totalAmount = getElementText(monetarySummation, 'GrandTotalAmount');

                console.log('7. ê¸ˆì•¡ ì •ë³´:');
                console.log('   - ê³µê¸‰ê°€ì•¡:', subtotal);
                console.log('   - ì„¸ì•¡:', taxAmount);
                console.log('   - í•©ê³„:', totalAmount);
                console.log('=== XML íŒŒì‹± ì™„ë£Œ ===');

                const [year, month, day] = [issueDate.substring(0, 4), issueDate.substring(4, 6), issueDate.substring(6, 8)];

                let html = `
                    <div class="title">ì „ìì„¸ê¸ˆê³„ì‚°ì„œ_ì¼ë°˜</div>

                    <div class="approval-info">
                        ìŠ¹ì¸ë²ˆí˜¸ <strong>${formatApprovalNumber(issueId)}</strong>
                    </div>

                    <table class="unified-party-table">
                        <tr>
                            <td rowspan="5" class="party-indicator pink">ê³µ<br/>ê¸‰<br/>ì</td>
                            <td class="party-label">ë“±ë¡ë²ˆí˜¸</td>
                            <td class="party-value" style="width: 15%;">${formatBRN(invoicerBrn)}</td>
                            <td class="party-label">ì¢…ì‚¬ì—…ì¥ ë²ˆí˜¸</td>
                            <td class="party-value" style="width: 15%;"></td>
                            <td rowspan="5" class="party-indicator blue">ê³µ<br/>ê¸‰<br/>ë°›<br/>ëŠ”<br/>ì</td>
                            <td class="party-label blue">ë“±ë¡ë²ˆí˜¸</td>
                            <td class="party-value" style="width: 15%;">${formatBRN(invoiceeBrn)}</td>
                            <td class="party-label blue">ì¢…ì‚¬ì—…ì¥ ë²ˆí˜¸</td>
                            <td class="party-value" style="width: 15%;"></td>
                        </tr>
                        <tr>
                            <td class="party-label">ìƒí˜¸</td>
                            <td class="party-value">${invoicerName}</td>
                            <td class="party-label">ì„±ëª…</td>
                            <td class="party-value">${invoicerPersonName}</td>
                            <td class="party-label blue">ìƒí˜¸</td>
                            <td class="party-value">${invoiceeName}</td>
                            <td class="party-label blue">ì„±ëª…</td>
                            <td class="party-value">${invoiceePersonName}</td>
                        </tr>
                        <tr>
                            <td class="party-label">ì‚¬ì—…ì¥<br/>ì£¼ì†Œ</td>
                            <td colspan="3" class="party-value address">${invoicerAddress}</td>
                            <td class="party-label blue">ì‚¬ì—…ì¥<br/>ì£¼ì†Œ</td>
                            <td colspan="3" class="party-value address">${invoiceeAddress}</td>
                        </tr>
                        <tr>
                            <td class="party-label">ì—…íƒœ</td>
                            <td class="party-value">${invoicerTypeCode}</td>
                            <td class="party-label">ì¢…ëª©</td>
                            <td class="party-value">${invoicerClassCode}</td>
                            <td class="party-label blue">ì—…íƒœ</td>
                            <td class="party-value">${invoiceeTypeCode}</td>
                            <td class="party-label blue">ì¢…ëª©</td>
                            <td class="party-value">${invoiceeClassCode}</td>
                        </tr>
                        <tr>
                            <td class="party-label">ì´ë©”ì¼</td>
                            <td colspan="3" class="party-value">${invoicerEmail}</td>
                            <td class="party-label blue">ì´ë©”ì¼</td>
                            <td colspan="3" class="party-value">${invoiceeEmail}</td>
                        </tr>
                    </table>

                    <div class="date-section">
                        <table class="date-table">
                            <tr>
                                <td class="date-label">ì‘ì„±ì¼ì</td>
                                <td class="date-value">${formatDateDisplay(issueDate)}</td>
                                <td class="date-label">ê³µê¸‰ê°€ì•¡</td>
                                <td class="date-value" style="text-align: right;">${formatNumber(subtotal)}</td>
                            </tr>
                            <tr>
                                <td class="date-label">ì„¸ì•¡</td>
                                <td class="date-value" style="text-align: right;">${formatNumber(taxAmount)}</td>
                                <td class="date-label">ìˆ˜ì •ì‚¬ìœ </td>
                                <td class="date-value">${getAmendmentReason(amendmentCode)}</td>
                            </tr>
                            <tr>
                                <td colspan="2" class="date-label" style="text-align: center;">ë¹„ê³ </td>
                                <td colspan="2" class="date-value" style="height: 60px; vertical-align: top;">${descriptionText}</td>
                            </tr>
                        </table>
                    </div>

                    <div class="section-title">í’ˆëª©</div>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 3%;">ì›”</th>
                                <th style="width: 3%;">ì¼</th>
                                <th style="width: 35%;">í’ˆëª©</th>
                                <th style="width: 7%;">ê·œê²©</th>
                                <th style="width: 6%;">ìˆ˜ëŸ‰</th>
                                <th style="width: 12%;">ë‹¨ê°€</th>
                                <th style="width: 12%;">ê³µê¸‰ê°€ì•¡</th>
                                <th style="width: 12%;">ì„¸ì•¡</th>
                                <th style="width: 10%;">ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                itemData.forEach(item => {
                    html += `
                        <tr>
                            <td class="center">${month}</td>
                            <td class="center">${day}</td>
                            <td class="left">${item.name}</td>
                            <td class="center">-</td>
                            <td class="center">${item.quantity}</td>
                            <td>${formatNumber(item.unitPrice)}</td>
                            <td>${formatNumber(item.amount)}</td>
                            <td>${formatNumber(item.tax)}</td>
                            <td></td>
                        </tr>
                    `;
                });

                // ë¹ˆ í–‰ ì¶”ê°€
                html += `
                        <tr>
                            <td colspan="9"></td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="summary-section">
                        <div class="section-title">í•©ê³„ê¸ˆì•¡</div>
                        <table class="summary-table">
                            <tr>
                                <td class="summary-label" style="width: 15%;">í•©ê³„ê¸ˆì•¡</td>
                                <td style="width: 20%; text-align: right; font-weight: bold;">${formatNumber(totalAmount)}</td>
                                <td class="summary-label" style="width: 12%;">í˜„ê¸ˆ</td>
                                <td style="width: 18%; text-align: right; font-weight: bold;">${formatNumber(totalAmount)}</td>
                                <td class="summary-label" style="width: 12%;">ìˆ˜í‘œ</td>
                                <td style="width: 13%;"></td>
                            </tr>
                            <tr>
                                <td colspan="2" style="background: white;"></td>
                                <td class="summary-label">ì–´ìŒ</td>
                                <td style="width: 18%;"></td>
                                <td class="summary-label">ì™¸ìƒë¯¸ìˆ˜ê¸ˆ</td>
                                <td style="width: 13%;"></td>
                            </tr>
                        </table>
                    </div>

                    <div class="footer-text">ì´ ê¸ˆì•¡ì„ (ì²­êµ¬ ) í•©</div>
                `;

                invoicePaper.innerHTML = html;
            } catch (error) {
                showMessage('ë Œë”ë§ ì˜¤ë¥˜: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>

</html>